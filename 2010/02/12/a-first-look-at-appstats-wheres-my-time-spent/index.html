<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>A first look at Appstats - where's my time spent? - Blair Conrad</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blairconrad.com/2010/02/12/a-first-look-at-appstats-wheres-my-time-spent/">

        <meta name="author" content="Blair Conrad" />
        <meta name="keywords" content="AppEngine,Appstats,Development,LibraryHippo,Python" />
        <meta name="description" content="After hearing about the release of Google&#39;s App Engine SDK 1.3.1, I rushed out to try the new Appstats Event Recorder to help profile LibraryHippo. I didn&#39;t expect great things, as I&#39;m generally happy with the performance, with one notable exception, but I was curious about the tool …" />

        <meta property="og:site_name" content="Blair Conrad" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="A first look at Appstats - where&#39;s my time spent?"/>
        <meta property="og:url" content="https://blairconrad.com/2010/02/12/a-first-look-at-appstats-wheres-my-time-spent/"/>
        <meta property="og:description" content="After hearing about the release of Google&#39;s App Engine SDK 1.3.1, I rushed out to try the new Appstats Event Recorder to help profile LibraryHippo. I didn&#39;t expect great things, as I&#39;m generally happy with the performance, with one notable exception, but I was curious about the tool …"/>
        <meta property="article:published_time" content="2010-02-12" />
            <meta property="article:section" content="Development" />
            <meta property="article:tag" content="AppEngine" />
            <meta property="article:tag" content="Appstats" />
            <meta property="article:tag" content="Development" />
            <meta property="article:tag" content="LibraryHippo" />
            <meta property="article:tag" content="Python" />
            <meta property="article:author" content="Blair Conrad" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blairconrad.com/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blairconrad.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blairconrad.com/theme/css/pygments/github.css" rel="stylesheet">
    <link href="https://blairconrad.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/style.css" type="text/css"/>
        <link href="https://blairconrad.com/theme/css/custom.css" rel="stylesheet">

        <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blair Conrad ATOM Feed"/>

        <link href="https://blairconrad.com/feeds/development.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blair Conrad Development ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blairconrad.com/" class="navbar-brand">
Blair Conrad            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/Recipes">Recipes</a></li>
                        <li class="active">
                            <a href="https://blairconrad.com/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="https://blairconrad.com/category/miscellany.html">Miscellany</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blairconrad.com/2010/02/12/a-first-look-at-appstats-wheres-my-time-spent/"
                       rel="bookmark"
                       title="Permalink to A first look at Appstats - where's my time spent?">
                        A first look at Appstats - where's my time spent?
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span><i class="fa fa-calendar"></i><time datetime="2010-02-12T00:00:00-05:00">2010-02-12</time></span>
    <span><i class="fa fa-folder"></i><a href="https://blairconrad.com/category/development.html"></i>Development</a></span>


<span><i class="fa fa-tags"></i>
<a href="https://blairconrad.com/tag/appengine.html">AppEngine</a>
/
<a href="https://blairconrad.com/tag/appstats.html">Appstats</a>
/
<a href="https://blairconrad.com/tag/development.html">Development</a>
/
<a href="https://blairconrad.com/tag/libraryhippo.html">LibraryHippo</a>
/
<a href="https://blairconrad.com/tag/python.html">Python</a>
</span>
    

</footer><!-- /.post-info -->                    </div>
                </div>
                <p>After hearing about the release of Google's App Engine SDK 1.3.1, I rushed out to try the new <a href="http://code.google.com/appengine/docs/python/tools/appstats.html">Appstats Event Recorder</a> to help profile LibraryHippo. I didn't expect great things, as I'm generally happy with the performance, with one notable exception, but I was curious about the tool.</p>
<p>App Engine Fan has posted <a href="http://blog.appenginefan.com/2010/02/art-of-unobtrusive-tools.html">a great introduction</a> of  some of the features that make Appstats a useful and powerful tool - it's very easy to hook up, and seems to add very little overhead. In addition, it has very rich configuration options - one can omit classes of calls, fold calls together, select the amount of information retained about each call, and specify how many such records are retained (in what amounts to a circular buffer).</p>
<p>I didn't use (or need) any particularly advanced configuration, so I just <a href="http://code.google.com/p/libraryhippo/issues/detail?id=47">installed the Event Recorder</a> and let it go.</p>
<p>Here's what I saw:</p>
<p><img src="https://blairconrad.com/images/no_rwl.png" alt="Appstats result for checking one family with just Waterloo and Kitchener accounts" title="checking one family, Waterloo and Kitchener libraries" width="746" height="425" class="size-full wp-image-322" /></p>
<p>I don't have an in-depth analysis, but here are some impressions: 
<ul>
<li>it's pretty</li>
<li>the information is presented very well - with only minimal reading, I can see that LibraryHippo made a handful of datastore queries, as well as a series of urlfetch.Fetch calls for each library card it checked</li>
<li>I can get a quick view of what's taking what proportion of the time - for example, the fetches easily dominate</li>
<li>total time (about 2.3 seconds) is easy to find, as well as the amount taken by the underlying API - 73 milliseconds</li>
<li>there's something else that's going on - 1056 ms for cpu + api - nearly half the elapsed time. I'm not sure what that means exactly</li>
</ul></p>
<p>So far, no big surprises - I knew that most of the time was taken up by queries to the library web pages, but it's very cool to see it this way, and to see how much time is taken up going to the Datastore (not much). There's room for improvement, but 2.3 seconds is more than acceptable for this family - one of LibraryHippo's heaviest users.</p>
<p>Two things did stand out, though. First, in the first group of urlfetch.Fetches, <strong>there are gaps</strong> between the fourth, fifth, and sixth calls (the ones that take 128 ms, 91ms, and 52ms) and the pattern repeats (with smaller gaps) in the second batches. This is where the retrieved records are processed and transformed into a normalized representation before rendering. The total time taken is a small, but I didn't expect to see <i>anything</i>. </p>
<p>Second, there's a datastore_v3.Get call before each card is checked. This is <strong>not an explicit call</strong> that LibraryHippo makes, so I clicked on the line in the graph and got a detailed view of what was going on:</p>
<p><img src="https://blairconrad.com/images/implicit_get.png" alt="Detail of implicit datastore_v3.get call" title="Detail of implicit get" width="751" height="407" class="size-full wp-image-328" /></p>
<p>It looks like the call is coming from the <code>create</code> method on line 8 of the all_libraries.py file. Curious, I click on that line and lo and behold, <strong>I get a view of the source</strong>. This is very cool.</p>
<pre>
<span id="n1">   1: #!/usr/bin/env python
</span><span id="n2">   2: 
</span><span id="n3">   3: import sys
</span><span id="n4">   4: 
</span><span id="n5">   5: modules = {}
</span><span id="n6">   6: 
</span><span id="n7">   7: def create(card, fetcher):
</span><span id="n8" style="background-color:yellow;">   8:     id = card.library.type
</span><span id="n9">   9:     if not modules.has_key(id):
</span><span id="n10">  10:         modules[id] = __import__(id)
</span><span id="n11">  11:     return modules[id].LibraryAccount(card, fetcher)
</span><span id="n12">  12: 
</span><span id="n13">  13: def main(args=None):
</span><span id="n14">  14:     if args == None:
</span><span id="n15">  15:         args = sys.argv[1:]
</span><span id="n16">  16:     return 0</span>
</pre>

<p>Correlating the detail view and the source code, we see that <code>create</code> is handed a card parameter that has an as-yet-unresolved <code>library</code> instance. Accessing the library attribute on the card must complete what was a lazy load initiated when I loaded the Family entity - the cards come from the Family.card_set member.</p>
<p>Ordinarily, I might start investigating the gaps and the implicit gets, but I know there's a much greater threat to LibraryHippo usability, which I confirm by checking out the record for another family's notification:</p>
<p><img src="https://blairconrad.com/images/with_rwl.png" alt="Appstats results of checking one family, with a Region of Waterloo Account" title="checking one family, with a Region of Waterloo Account" width="757" height="665" class="size-full wp-image-321" /></p>
<p>Here's where the presentation really packs a wallop - there's clearly a qualitative difference here. And what a difference - instead of 2.5 seconds on the horizontal axis, it's 25 seconds, and most of the fetches are compressed to nigh-invisibility.</p>
<p>There are two differences between this family's accounts and the first family's: they have an extra Kitchener Library card that the first family didn't, and they have a Region of Waterloo Library card. It's the RWL card that makes the difference: you can see it being checked in the last batch of urlfetch.Fetches. 
The 4 Waterloo and Kitchener library card checks are completely done after 3154ms, but the Region of Waterloo checking goes on for a further 21 seconds - for one library, and it's not an aberration - the library web site is <i>slow</i>.</p>
<p>This post is already long enough, so I'll use an upcoming one to talk about what this slowness means for LibraryHippo and how I've tried to keep it from destroying the user experience.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Blair Conrad
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blairconrad.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blairconrad.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blairconrad.com/theme/js/respond.min.js"></script>




</body>
</html>