<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Auto-deploying TypeMock Isolator Without Trashing the Installation - Blair Conrad</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blairconrad.com/2010/06/06/auto-deploying-typemock-isolator-without-trashing-the-installation/">

        <meta name="author" content="Blair Conrad" />
        <meta name="keywords" content="Isolator,MSBuild,Testing,TypeMock" />
        <meta name="description" content="At the Day Job, we use TypeMock Isolator as the isolation framework for the client portion of our flagship product. Historically we&#39;d used version 3, but recently I had the opportunity to upgrade the code and build system to use the 2010 (or &#34;version 6&#34;) edition. Backward Compatibility I was …" />

        <meta property="og:site_name" content="Blair Conrad" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Auto-deploying TypeMock Isolator Without Trashing the Installation"/>
        <meta property="og:url" content="https://blairconrad.com/2010/06/06/auto-deploying-typemock-isolator-without-trashing-the-installation/"/>
        <meta property="og:description" content="At the Day Job, we use TypeMock Isolator as the isolation framework for the client portion of our flagship product. Historically we&#39;d used version 3, but recently I had the opportunity to upgrade the code and build system to use the 2010 (or &#34;version 6&#34;) edition. Backward Compatibility I was …"/>
        <meta property="article:published_time" content="2010-06-06" />
            <meta property="article:section" content="Development" />
            <meta property="article:tag" content="Isolator" />
            <meta property="article:tag" content="MSBuild" />
            <meta property="article:tag" content="Testing" />
            <meta property="article:tag" content="TypeMock" />
            <meta property="article:author" content="Blair Conrad" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blairconrad.com/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blairconrad.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blairconrad.com/theme/css/pygments/github.css" rel="stylesheet">
    <link href="https://blairconrad.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/style.css" type="text/css"/>
        <link href="https://blairconrad.com/theme/css/custom.css" rel="stylesheet">

        <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blair Conrad ATOM Feed"/>

        <link href="https://blairconrad.com/feeds/development.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blair Conrad Development ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blairconrad.com/" class="navbar-brand">
Blair Conrad            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/Recipes">Recipes</a></li>
                        <li class="active">
                            <a href="https://blairconrad.com/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="https://blairconrad.com/category/miscellany.html">Miscellany</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blairconrad.com/2010/06/06/auto-deploying-typemock-isolator-without-trashing-the-installation/"
                       rel="bookmark"
                       title="Permalink to Auto-deploying TypeMock Isolator Without Trashing the Installation">
                        Auto-deploying TypeMock Isolator Without Trashing the Installation
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span><i class="fa fa-calendar"></i><time datetime="2010-06-06T00:00:00-04:00">2010-06-06</time></span>
    <span><i class="fa fa-folder"></i><a href="https://blairconrad.com/category/development.html"></i>Development</a></span>


<span><i class="fa fa-tags"></i>
<a href="https://blairconrad.com/tag/isolator.html">Isolator</a>
/
<a href="https://blairconrad.com/tag/msbuild.html">MSBuild</a>
/
<a href="https://blairconrad.com/tag/testing.html">Testing</a>
/
<a href="https://blairconrad.com/tag/typemock.html">TypeMock</a>
</span>
    

</footer><!-- /.post-info -->                    </div>
                </div>
                <p>At the Day Job, we use <a href="http://site.typemock.com/typemock-isolator-product">TypeMock Isolator</a> as the isolation framework for the client portion of our flagship product. Historically we'd used version 3, but recently I had the opportunity to upgrade the code and build system to use the 2010 (or "version 6") edition.</p>

<h4>Backward Compatibility</h4>

<p>I was very pleased to see that no code changes were <i>required</i> with the upgrade. Sure, we'd like to start using the new <a href="http://www.typemock.com/Docs/UserGuide/">Arrange-Act-Assert API</a>, and to trade in the method name strings for the type-safe lambda expressions, but I didn't want to have to run back and convert everything today. And I didn't. Typemock Isolator appears to be backward compatible (at least as far as the feature set we use goes).</p>

<h4>Auto-Deployment</h4>

<p>In fact, the whole exercise of moving up to  2010 would've been over in almost no time were it not for one thing&mdash;we need to auto-deploy Isolator. The reasons are several:
<ul>
<li>we have many dozen people working on the product, spread across four teams and three offices all over the world, so coordinating the installation is tricky</li>
<li>some people have a need to occasionally build the product, but don't actively develop it - imposing an install on them seems rude</li>
<li>some of our developers actively oppose unit testing, and I didn't want to give them any more ammunition than I had to</li>
</ul>
<p>We'd had a home-grown auto-deploy solution working with Isolator 3, but it was a little clunky and some of the details of the Isolator install had changed, so it wasn't really up to auto-deploying 6. Fortunately, I found a <a href="http://blog.typemock.com/2010/01/auto-deploy-typemock-isolator_25.html">Typemock Insider blog post about auto-deploying</a>.</p>
<p>We use <a href="http://ant.apache.org/">Apache Ant</a> for our builds, but it was no trouble to shell out to an <a href="http://msdn.microsoft.com/en-us/library/0k6kkbsd.aspx">MSBuild</a> task to auto-deploy Isolator:</p>
<pre><code class="xml">&lt;Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"&gt;
  &lt;PropertyGroup&gt;
    &lt;TypeMockLocation&gt;path\to\TypeMock\Isolator\files&lt;/TypeMockLocation&gt;
    &lt;NUNIT&gt;path\to\nunit-console.exe&lt;/NUNIT&gt;
  &lt;/PropertyGroup&gt;  </p>
<p>&lt;Import Project="$(TypeMockLocation)\TypeMock.MSBuild.Tasks"/&gt;</p>
<p>&lt;Target Name="RegisterTypeMock"&gt;
    &lt;TypeMockRegister Company="MyCompany" License="XXX-XXX" AutoDeploy="true"/&gt; 
    &lt;TypeMockStart/&gt;
    &lt;Exec ContinueOnError="false" Command="$(NUNIT) $(TestAssembly)"/&gt;
    &lt;TypeMockStop Undeploy="true"/&gt;
  &lt;/Target&gt;
 &lt;/Project&gt;</code></pre></p>
<h4>Build Server Licenses</h4>

<p>This worked really well - I was testing the tests on my local machine, watching Isolator auto-deploy and auto-undeploy. Everything was great, until I realized: we have two licenses&mdash;one for developers, and one for build servers. It only seemed right to use the appropriate one depending on whether we were building on a developer's machine or a build server. Fortunately, all our build servers set a specific environment variable, so it was a simple matter to have MSBuild pick the correct one.</p>

<h4>Undeploying Isolator Mangles the Installed Instance</h4>

<p>Even though we're providing a mechanism for auto-deploying Isolator, some developers will prefer to install it in order to use the Visual Studio AddIn to aid debugging. I'd heard that undoing the auto-deployment could wreak havoc with the installed version of Typemock Isolator, and that it's sometime necessary to repair the installed instance. A little testing, with the help of a coworker, showed this to be the case. Worse, it appeared that the auto-deploy/undeploy broke his ability to run the product in the IDE - as soon as the process started, it would end, with a "CLR error 80004005". Disabling the Isolator AddIn made the error go away.</p>

<p>So it looked like we'd need to figure out how not to break installed Isolator instances while still supplying auto-deployment when it's needed. Searching found nothing promising, so I resorted to Registry spelunking. Unfortunately, the installed Isolator and auto-deployed Isolator make very similar Registry entries - there was nothing that I felt confident basing "Is Isolator installed?" on. After poking around and coming up short, I fell back to using the filesystem. By default, Isolator is installed in <code>%ProgramFiles%\TypeMock\Isolator\6.0</code>, so I decided to use that as the determinant. I'd feel dirty doing this for code destined for a customer's site, but I can live with telling our own developers that if they choose to install Isolator, they should install it in the default location or face the consequences.</p>

<p>Still, if anyone comes up with a more reliable way to determine if Isolator is installed, please post it in the comments.</p>

<h4>Putting it all Together</h4>

<p>Here's the MSBuild file I ended up with. It uses the correct license based on machine type, and only auto-deploys/undeploys when Isolator isn't installed - existing installations are left alone.</p>

<pre><code class="xml">&lt;Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"&gt;
  &lt;PropertyGroup&gt;
    &lt;TypeMockLocation&gt;path\to\TypeMock\Isolator\files&lt;/TypeMockLocation&gt;
    &lt;NUNIT&gt;path\to\nunit-console.exe&lt;/NUNIT&gt;

    &lt;!-- Used to detect TypeMock installs. --&gt;
    &lt;UsualTypeMockInstallDir&gt;$(ProgramFiles)\TypeMock\Isolator\6.0&lt;/UsualTypeMockInstallDir&gt;

    &lt;!-- 
         Only deploy Typemock if it's not already in the usual install dir.

         If developers install Typemock, they should install it in the
         default location in order to help the build system decide
         whether or not we need to auto-deploy (since auto-deploy and
         undeploy can corrupt the TypeMock VisusalStudio Add-In, and
         interfere with the ability to run programs in the IDE.
      --&gt;
    &lt;DeployTypeMock&gt;false&lt;/DeployTypeMock&gt;
    &lt;DeployTypeMock Condition="!Exists('$(UsualTypeMockInstallDir)')"&gt;true&lt;/DeployTypeMock&gt;

    &lt;License&gt;XXX-XXX&lt;/License&gt;
    &lt;License Condition="'$(BuildServer)' != ''"&gt;YYY-YYY&lt;/License&gt;
  &lt;/PropertyGroup&gt;
  &lt;Import Project="$(TypeMockLocation)\TypeMock.MSBuild.Tasks"/&gt;
  &lt;Target Name="RegisterTypeMock"&gt;
    &lt;TypeMockRegister Company="MyCompany" License="$(License)" AutoDeploy="$(DeployTypeMock)"/&gt; 
    &lt;TypeMockStart/&gt;
    &lt;Exec ContinueOnError="false" Command="$(NUNIT) $(TestAssembly)" /&gt;
    &lt;TypeMockStop Undeploy="$(DeployTypeMock)"/&gt;
  &lt;/Target&gt;
&lt;/Project&gt;</code></pre>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Blair Conrad
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blairconrad.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blairconrad.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blairconrad.com/theme/js/respond.min.js"></script>




</body>
</html>