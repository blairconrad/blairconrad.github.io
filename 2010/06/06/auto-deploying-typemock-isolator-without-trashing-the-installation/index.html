<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Blair Conrad" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Isolator, MSBuild, Testing, TypeMock, Development, " />

<meta property="og:title" content="Auto-deploying TypeMock Isolator Without Trashing the Installation "/>
<meta property="og:url" content="https://blairconrad.com/2010/06/06/auto-deploying-typemock-isolator-without-trashing-the-installation/" />
<meta property="og:description" content="At the Day Job, we use TypeMock Isolator as the isolation framework for the client portion of our flagship product. Historically we&#39;d used version 3, but recently I had the opportunity to upgrade the code and build system to use the 2010 (or &#34;version 6&#34;) edition. Backward Compatibility I was …" />
<meta property="og:site_name" content="Blair Conrad" />
<meta property="og:article:author" content="Blair Conrad" />
<meta property="og:article:published_time" content="2010-06-06T00:00:00-04:00" />
<meta name="twitter:title" content="Auto-deploying TypeMock Isolator Without Trashing the Installation ">
<meta name="twitter:description" content="At the Day Job, we use TypeMock Isolator as the isolation framework for the client portion of our flagship product. Historically we&#39;d used version 3, but recently I had the opportunity to upgrade the code and build system to use the 2010 (or &#34;version 6&#34;) edition. Backward Compatibility I was …">

        <title>Auto-deploying TypeMock Isolator Without Trashing the Installation  · Blair Conrad
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blairconrad.com/theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blairconrad.com/theme/css/custom.css" media="screen">

        <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blair Conrad - Full Atom Feed" />


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://blairconrad.com/"><span class=site-name>Blair Conrad</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://blairconrad.com
                                    >Home</a>
                                </li>
                                <li ><a href="https://blairconrad.com/categories.html">Categories</a></li>
                                <li ><a href="https://blairconrad.com/tags.html">Tags</a></li>
                                <li ><a href="https://blairconrad.com/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://blairconrad.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://blairconrad.com/2010/06/06/auto-deploying-typemock-isolator-without-trashing-the-installation/">
                Auto-deploying TypeMock Isolator Without Trashing the Installation
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>At the Day Job, we use <a href="http://site.typemock.com/typemock-isolator-product">TypeMock Isolator</a> as the isolation framework for the client portion of our flagship product. Historically we'd used version 3, but recently I had the opportunity to upgrade the code and build system to use the 2010 (or "version 6") edition.</p>

<h4>Backward Compatibility</h4>

<p>I was very pleased to see that no code changes were <i>required</i> with the upgrade. Sure, we'd like to start using the new <a href="http://www.typemock.com/Docs/UserGuide/">Arrange-Act-Assert API</a>, and to trade in the method name strings for the type-safe lambda expressions, but I didn't want to have to run back and convert everything today. And I didn't. Typemock Isolator appears to be backward compatible (at least as far as the feature set we use goes).</p>

<h4>Auto-Deployment</h4>

<p>In fact, the whole exercise of moving up to  2010 would've been over in almost no time were it not for one thing&mdash;we need to auto-deploy Isolator. The reasons are several:
<ul>
<li>we have many dozen people working on the product, spread across four teams and three offices all over the world, so coordinating the installation is tricky</li>
<li>some people have a need to occasionally build the product, but don't actively develop it - imposing an install on them seems rude</li>
<li>some of our developers actively oppose unit testing, and I didn't want to give them any more ammunition than I had to</li>
</ul>
<p>We'd had a home-grown auto-deploy solution working with Isolator 3, but it was a little clunky and some of the details of the Isolator install had changed, so it wasn't really up to auto-deploying 6. Fortunately, I found a <a href="http://blog.typemock.com/2010/01/auto-deploy-typemock-isolator_25.html">Typemock Insider blog post about auto-deploying</a>.</p>
<p>We use <a href="http://ant.apache.org/">Apache Ant</a> for our builds, but it was no trouble to shell out to an <a href="http://msdn.microsoft.com/en-us/library/0k6kkbsd.aspx">MSBuild</a> task to auto-deploy Isolator:</p>
<pre><code class="xml">&lt;Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"&gt;
  &lt;PropertyGroup&gt;
    &lt;TypeMockLocation&gt;path\to\TypeMock\Isolator\files&lt;/TypeMockLocation&gt;
    &lt;NUNIT&gt;path\to\nunit-console.exe&lt;/NUNIT&gt;
  &lt;/PropertyGroup&gt;  </p>
<p>&lt;Import Project="$(TypeMockLocation)\TypeMock.MSBuild.Tasks"/&gt;</p>
<p>&lt;Target Name="RegisterTypeMock"&gt;
    &lt;TypeMockRegister Company="MyCompany" License="XXX-XXX" AutoDeploy="true"/&gt; 
    &lt;TypeMockStart/&gt;
    &lt;Exec ContinueOnError="false" Command="$(NUNIT) $(TestAssembly)"/&gt;
    &lt;TypeMockStop Undeploy="true"/&gt;
  &lt;/Target&gt;
 &lt;/Project&gt;</code></pre></p>
<h4>Build Server Licenses</h4>

<p>This worked really well - I was testing the tests on my local machine, watching Isolator auto-deploy and auto-undeploy. Everything was great, until I realized: we have two licenses&mdash;one for developers, and one for build servers. It only seemed right to use the appropriate one depending on whether we were building on a developer's machine or a build server. Fortunately, all our build servers set a specific environment variable, so it was a simple matter to have MSBuild pick the correct one.</p>

<h4>Undeploying Isolator Mangles the Installed Instance</h4>

<p>Even though we're providing a mechanism for auto-deploying Isolator, some developers will prefer to install it in order to use the Visual Studio AddIn to aid debugging. I'd heard that undoing the auto-deployment could wreak havoc with the installed version of Typemock Isolator, and that it's sometime necessary to repair the installed instance. A little testing, with the help of a coworker, showed this to be the case. Worse, it appeared that the auto-deploy/undeploy broke his ability to run the product in the IDE - as soon as the process started, it would end, with a "CLR error 80004005". Disabling the Isolator AddIn made the error go away.</p>

<p>So it looked like we'd need to figure out how not to break installed Isolator instances while still supplying auto-deployment when it's needed. Searching found nothing promising, so I resorted to Registry spelunking. Unfortunately, the installed Isolator and auto-deployed Isolator make very similar Registry entries - there was nothing that I felt confident basing "Is Isolator installed?" on. After poking around and coming up short, I fell back to using the filesystem. By default, Isolator is installed in <code>%ProgramFiles%\TypeMock\Isolator\6.0</code>, so I decided to use that as the determinant. I'd feel dirty doing this for code destined for a customer's site, but I can live with telling our own developers that if they choose to install Isolator, they should install it in the default location or face the consequences.</p>

<p>Still, if anyone comes up with a more reliable way to determine if Isolator is installed, please post it in the comments.</p>

<h4>Putting it all Together</h4>

<p>Here's the MSBuild file I ended up with. It uses the correct license based on machine type, and only auto-deploys/undeploys when Isolator isn't installed - existing installations are left alone.</p>

<pre><code class="xml">&lt;Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"&gt;
  &lt;PropertyGroup&gt;
    &lt;TypeMockLocation&gt;path\to\TypeMock\Isolator\files&lt;/TypeMockLocation&gt;
    &lt;NUNIT&gt;path\to\nunit-console.exe&lt;/NUNIT&gt;

    &lt;!-- Used to detect TypeMock installs. --&gt;
    &lt;UsualTypeMockInstallDir&gt;$(ProgramFiles)\TypeMock\Isolator\6.0&lt;/UsualTypeMockInstallDir&gt;

    &lt;!-- 
         Only deploy Typemock if it's not already in the usual install dir.

         If developers install Typemock, they should install it in the
         default location in order to help the build system decide
         whether or not we need to auto-deploy (since auto-deploy and
         undeploy can corrupt the TypeMock VisusalStudio Add-In, and
         interfere with the ability to run programs in the IDE.
      --&gt;
    &lt;DeployTypeMock&gt;false&lt;/DeployTypeMock&gt;
    &lt;DeployTypeMock Condition="!Exists('$(UsualTypeMockInstallDir)')"&gt;true&lt;/DeployTypeMock&gt;

    &lt;License&gt;XXX-XXX&lt;/License&gt;
    &lt;License Condition="'$(BuildServer)' != ''"&gt;YYY-YYY&lt;/License&gt;
  &lt;/PropertyGroup&gt;
  &lt;Import Project="$(TypeMockLocation)\TypeMock.MSBuild.Tasks"/&gt;
  &lt;Target Name="RegisterTypeMock"&gt;
    &lt;TypeMockRegister Company="MyCompany" License="$(License)" AutoDeploy="$(DeployTypeMock)"/&gt; 
    &lt;TypeMockStart/&gt;
    &lt;Exec ContinueOnError="false" Command="$(NUNIT) $(TestAssembly)" /&gt;
    &lt;TypeMockStop Undeploy="$(DeployTypeMock)"/&gt;
  &lt;/Target&gt;
&lt;/Project&gt;</code></pre>


             
 
            
            
            






            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="https://blairconrad.com/2010/05/22/when-fields-are-initialized-or-lies-reflector-told-me/" title="Previous: When Fields are Initialized, or &#34;Lies Reflector Told Me&#34;">When Fields are Initialized, or "Lies Reflector Told Me"</a></li>
                <li class="next-article"><a href="https://blairconrad.com/2010/07/02/using-xsl-to-arbitrarily-order-strings-lessons-from-professor-layton/" title="Next: Using XSL to arbitrarily order strings - lessons from Professor Layton">Using XSL to arbitrarily order strings - lessons from Professor Layton</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2010-06-06T00:00:00-04:00">2010-06-06</time>
            <h4>Category</h4>
            <a class="category-link" href="https://blairconrad.com/categories.html#development-ref">Development</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://blairconrad.com/tags.html#isolator-ref">Isolator
                    <span>5</span>
</a></li>
                <li><a href="https://blairconrad.com/tags.html#msbuild-ref">MSBuild
                    <span>1</span>
</a></li>
                <li><a href="https://blairconrad.com/tags.html#testing-ref">Testing
                    <span>10</span>
</a></li>
                <li><a href="https://blairconrad.com/tags.html#typemock-ref">TypeMock
                    <span>5</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="http://github.com/blairconrad" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="http://twitter.com/hippopottoman" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://www.goodreads.com/user/show/1066544-blair-conrad" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><rect fill="#EAE6CF" height="512" rx="64" width="512"/><path d="m254.92444 336.92444c43.2889-.36 74.07112-22.01333 92.33334-64.95111h.95556v65.48889c0 4.88-.32 12.44889-.95556 22.73333-1.30222 10.64445-4.78222 22.10223-10.42666 34.36889-5.65778 11.54667-14.79112 21.38667-27.37778 29.49778-12.44889 8.84-29.81778 13.44-52.12001 13.80444-21.48444 0-39.65333-5.59555-54.52444-16.77777-15.2-11.00889-24.08001-28.87111-26.65778-53.58667h-18.89778c1.93778 32.11111 12.18667 55.02667 30.76444 68.74222 18.08889 13.16445 41.04001 19.75556 68.83556 19.75556 27.45778 0 48.87112-5.14223 64.21778-15.43111 15.18223-9.92 26.08445-22.28445 32.71556-37.08 6.62222-14.79111 10.58222-28.86667 11.86667-42.21334.98222-13.35555 1.45778-22.91555 1.45778-28.68889v-270.088875h-18.90667v59.537775h-.95556c-7.27555-21.82667-19.30666-38.333335-36.12-49.524445-16.96-11.00445-35.70222-16.51111-56.21333-16.51111-35.72001.72444-62.85779 14.52444-81.43112 41.40889-19.07111 26.697775-28.59556 59.631105-28.59556 98.782195 0 40.23557 9.04445 73.52001 27.13334 99.86224 18.27555 26.88889 45.89778 40.51111 82.90222 40.87111zm-68.34222-224.89777c14.85333-24.359995 37.63111-36.986665 68.34222-37.888885 31.50223.90666 54.83556 13.17333 70.03556 36.808885 15.18223 23.64 22.77778 52.05331 22.77778 85.25331s-7.59555 61.43112-22.77778 84.70668c-15.2 24.72444-38.53333 37.34667-70.03556 37.88889-29.72889-.54667-52.36-12.81778-67.86222-36.80889-15.67556-23.27556-23.50667-51.87112-23.50667-85.79112-.004-31.75556 7.67111-59.81332 23.02667-84.16887z" fill="#743901"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>