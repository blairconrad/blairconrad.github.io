<!DOCTYPE html>
<html lang="en"     prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" >

<head>
    <title>Making a Duck-Dog using FakeItEasy's CallsBaseMethod(s) - Blair Conrad</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blairconrad.com/2014/08/29/making-a-duck-dog-using-fakeiteasys-callsbasemethods/">

        <meta name="author" content="Blair Conrad" />
        <meta name="keywords" content="FakeItEasy,.NET" />
        <meta name="description" content="A while back, Roman Turovskyy wrote FakeItEasy: Be Careful When Wrapping an Existing Object, an interesting post highlighting some of the difficulties of faking classes (as opposed to interfaces, which by virtue of having no behaviour of their own, are quite a bit more predictable). It&#39;s well-written and I enjoyed …" />

        <meta property="og:site_name" content="Blair Conrad" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Making a Duck-Dog using FakeItEasy&#39;s CallsBaseMethod(s)"/>
        <meta property="og:url" content="https://blairconrad.com/2014/08/29/making-a-duck-dog-using-fakeiteasys-callsbasemethods/"/>
        <meta property="og:description" content="A while back, Roman Turovskyy wrote FakeItEasy: Be Careful When Wrapping an Existing Object, an interesting post highlighting some of the difficulties of faking classes (as opposed to interfaces, which by virtue of having no behaviour of their own, are quite a bit more predictable). It&#39;s well-written and I enjoyed …"/>
        <meta property="article:published_time" content="2014-08-29" />
            <meta property="article:section" content="Development" />
            <meta property="article:tag" content="FakeItEasy" />
            <meta property="article:tag" content=".NET" />
            <meta property="article:author" content="Blair Conrad" />



    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/bootstrap.min.css" type="text/css" />

    <link href="https://blairconrad.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blairconrad.com/theme/css/pygments/github.css"
        rel="stylesheet">
    <link href="https://blairconrad.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/style.css" type="text/css" />
    <link href="https://blairconrad.com/theme/css/custom.css" rel="stylesheet">

    <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
        title="Blair Conrad ATOM Feed" />

    <link href="https://blairconrad.com/feeds/development.atom.xml" type="application/atom+xml" rel="alternate"
        title="Blair Conrad Development ATOM Feed" />
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top"
        role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="https://blairconrad.com/" class="navbar-brand">
Blair Conrad                </a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/Recipes">Recipes</a></li>
                        <li class="active" >
                            <a href="https://blairconrad.com/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="https://blairconrad.com/category/miscellany.html">Miscellany</a>
                        </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><span>
                            <form class="navbar-search" action="/search.html">
                                <input type="text" class="search-query" placeholder="Search" name="q"
                                    id="tipue_search_input" required>
                            </form>
                        </span>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
    </div> <!-- /.navbar -->

    <!-- Banner -->
    <!-- End Banner -->

    <!-- Content Container -->
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blairconrad.com/2014/08/29/making-a-duck-dog-using-fakeiteasys-callsbasemethods/"
                       rel="bookmark"
                       title="Permalink to Making a Duck-Dog using FakeItEasy's CallsBaseMethod(s)">
                        Making a Duck-Dog using FakeItEasy's CallsBaseMethod(s)
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span><i class="fa fa-calendar"></i><time datetime="2014-08-29T00:00:00-04:00">2014-08-29</time></span>
    <span><i class="fa fa-folder"></i><a href="https://blairconrad.com/category/development.html"></i>Development</a></span>


<span><i class="fa fa-tags"></i>
<a href="https://blairconrad.com/tag/fakeiteasy.html">FakeItEasy</a>
/
<a href="https://blairconrad.com/tag/.net.html">.NET</a>
</span>
    

</footer><!-- /.post-info -->                    </div>
                </div>
                <p>A while back, Roman Turovskyy wrote
<a href="http://elekslabs.com/2014/03/fakeiteasy-be-careful-when-wrapping.html">FakeItEasy: Be Careful When Wrapping an Existing Object</a>,
an interesting post highlighting some of the difficulties of faking
classes (as opposed to interfaces, which by virtue of having no
behaviour of their own, are quite a bit more predictable). It's
well-written and I enjoyed it, but he overlooked a small point. I
figured others may easily make the same omission, so I'd like to
explain why the example from that post works as it does, and to
provide an alternative solution.</p>
<hr>
<p>Mr. Turovskyy supposes we want to fake out the following <code>Dog</code> class:</p>
<div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">Dog</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">virtual</span> <span class="n">string</span> <span class="n">Bark</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;Bark!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">public</span> <span class="n">virtual</span> <span class="n">string</span> <span class="n">BarkBark</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Bark</span><span class="p">()</span> <span class="o">+</span> <span class="n">Bark</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>He notes that the default behaviour of a fake Dog, as made by <code>dog =
A.Fake&lt;Dog&gt;()</code>, is for both <code>Bark</code> and <code>BarkBark</code> to return the empty
string, which is not always desirable.</p>
<p>His next step is to create a fake by <strong>wrapping a Dog object</strong>:</p>
<pre><code class="csharp">Dog realDog = newDog();
Dog dog = A.Fake&lt;Dog&gt;(x =&gt; x.Wrapping(realDog));</code></pre>

<p>Now <code>Bark</code> and <code>BarkBark</code> return the original (expected) strings.</p>
<p>Then Mr. Turovskyy addresses customizing the fake object to change
the way it barks.</p>
<p>Here, things break down a little bit. His desired goal, of using
<code>A.CallTo</code> to override <code>Bark</code> to return "Quack!" works, but when
<code>BarkBark</code> is called, it <strong>still returns "Bark!Bark!"</strong>.</p>
<p>He comments</p>
<blockquote>
<p>For those who know how virtual methods work, this looks very
counter-intuitive.</p>
</blockquote>
<p>And that's completely true. The problem is that <strong>when a fake wraps an
object, we're using a composition model, not inheritance</strong>. Thus the
fake Dog knows to call the real dog's <code>BarkBark</code> method, but <em>the real
dog doesn't know about the fake Dog at all</em>, so it just calls its own
<code>Bark</code> method, which returns "Bark!".</p>
<p>Using the <code>Wrapping</code> option and then overriding <code>Bark</code> on the fake is
equivalent to writing this manual wrapper:</p>
<pre><code class="csharp">public class WrappingDog: Dog
{
    private readonly Dog realDog;

    public WrappingDog(Dog realDog)
    {
        this.realDog = realDog;
    }

    public override string Bark()
    {
        return "Quack!";
    }

    public override string BarkBark()
    {
        return this.realDog.BarkBark();
    }
}</code></pre>

<p>Mr. Turovskyy suggests getting the desired behaviour by writing a
manual <code>FakeDog</code> that overrides <code>Bark</code>, which will work, but is
tedious and discards the benefits that FakeItEasy can provide.</p>
<h2>Another Way to Access Original Behaviour</h2>
<p>FakeItEasy can be used to get the desired behaviour. It provides a
<code>CallsBaseMethod</code> method when configuring a fake. It does just what
you'd hope it would. Witness:</p>
<pre><code class="csharp">Dog dog = A.Fake&lt;Dog&gt;();
A.CallTo(() =&gt; dog.BarkBark()).CallsBaseMethod();</code></pre>

<p>This tells the fake Dog to call the real <code>Dog.BarkBark</code> when its
<code>BarkBark</code> method is invoked. When this is combined with an override
for <code>Bark</code>, we can write this passing test:</p>
<pre><code class="csharp">[Test]
public void BarkBark_CallsBaseMethod_UsesOverriddenBark()
{
    Dog dog = A.Fake&lt;Dog&gt;();

    A.CallTo(() =&gt; dog.BarkBark()).CallsBaseMethod();
    A.CallTo(() =&gt; dog.Bark()).Returns("Quack!");

    string result = dog.BarkBark();

    Assert.That(result, Is.EqualTo("Quack!Quack!"));
}</code></pre>

<h2>Call Base Methods More Conveniently</h2>
<p>As of <a href="https://github.com/FakeItEasy/FakeItEasy/releases/tag/1.24.0">FakeItEasy 1.24.0</a>, there's an additional way to
do this, and it may appeal more to users who want many methods on
their fake to call the original class's version. There's a new
<a href="https://github.com/FakeItEasy/FakeItEasy/wiki/Creating-Fakes#options">fake creation option</a> called <a href="https://github.com/FakeItEasy/FakeItEasy/wiki/Calling-base-methods#configuring-all-methods-at-once"><code>CallsBaseMethods</code></a>. It was
<a href="https://github.com/FakeItEasy/FakeItEasy/issues/192">proposed</a> by <a href="http://alxandr.me/">Aleksander Heintz</a>, who also provided
nearly the complete implementation. When used, it will cause <em>every</em>
method on a fake to delegate to the faked type's implementation, if there
is one. So the previous test could be written as</p>
<pre><code class="csharp">[Test]
public void BarkBark_CallsBaseMethod_UsesOverriddenBark()
{
    Dog dog = A.Fake&lt;Dog&gt;(options =&gt; options.CallsBaseMethods());

    A.CallTo(() =&gt; dog.Bark()).Returns("Quack!");

    string result = dog.BarkBark();

    Assert.That(result, Is.EqualTo("Quack!Quack!"));
}</code></pre>

<p>The change in the first line means that when <code>dog</code> is created, every
method will delegate to the version on <code>Dog</code>.</p>
<p>Then <code>Bark</code> is overridden, and the base <code>BarkBark</code> is able to use the
new version.</p>
<p>Now we can realize our dream of having a
<a href="http://seuss.wikia.com/wiki/Duck-Dog">Seussian DuckDog</a>:
<figure>
  <img src="https://blairconrad.com/images/Duck-Dog.jpg">
</figure></p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

            </div>
        </div>
    </div>
    <!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Blair Conrad
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <script src="https://blairconrad.com/theme/js/jquery.min.js"></script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://blairconrad.com/theme/js/bootstrap.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://blairconrad.com/theme/js/respond.min.js"></script>




</body>

</html>