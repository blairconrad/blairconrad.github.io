<html>

<head>
    <title>Libby</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <link rel="icon" type="image/x-icon" href="/images/libraryhippo-icon-64.ico" />
    <style>
        #waiting-holds td:first-child {
            text-align: right;

            /* otherwise it fetches up against the next column */
            padding-right: 2em;
        }
    </style>
</head>

<body>
    <div id="content" />
    <script async>
        const proxy_base = 'https://libby-proxy.blairconrad.workers.dev/proxy?proxyUrl='
        const overdrive_url_base = 'https://sentry-read.svc.overdrive.com/'
        const bearerTokenKey = 'libby.bearer.token';
        window.onload = async (event) => {

            const location_url = new URL(window.location.href);

            if (location_url.searchParams.has('reset')) {
                window.localStorage.removeItem(bearerTokenKey);
            }

            var bearer = window.localStorage.getItem(bearerTokenKey);
            if (bearer) {
                loadContent(bearer);
            } else {
                const codeInput = document.createElement('input');
                codeInput.setAttribute('autocomplete', 'off');
                codeInput.setAttribute('autofocus', 'autofocus');
                codeInput.setAttribute('id', 'code');
                codeInput.setAttribute('maxlength', 8);
                codeInput.setAttribute('name', 'code');
                codeInput.setAttribute('pattern', '[0-9]{8}');
                codeInput.setAttribute('placeholder', '12345678');
                codeInput.setAttribute('required', 'required');
                codeInput.setAttribute('size', '8');
                codeInput.setAttribute('title', '8-digit one-time Libby code');
                codeInput.setAttribute('type', 'text');

                const codeSubmit = document.createElement('input');
                codeSubmit.setAttribute('type', 'submit');
                codeSubmit.setAttribute('value', 'Submit');

                const codeForm = document.createElement('form');
                codeForm.appendChild(codeInput);
                codeForm.appendChild(codeSubmit);
                codeForm.addEventListener('submit', cloneCode);

                const codeText = document.createElement('p');
                codeText.innerHTML = `
You don't appear to have registered your Libby Account. Enter an
8-digit code <a href="https://help.libbyapp.com/en-us/6070.htm">you can get from another logged-in
Libby account</a>.
`;

                const contentNode = document.getElementById('content');
                contentNode.replaceChildren(codeText, codeForm);
            }
        };

        async function loadContent(bearer) {
            const contentNode = document.getElementById('content');
            contentNode.innerHTML = 'loading&hellip;';

            const sync_path = 'chip/sync';
            const sync_url = proxy_base + encodeURI(overdrive_url_base + sync_path);
            const response = await fetch(sync_url, { headers: { 'Authorization': 'Bearer ' + bearer } });
            const sync_data = await response.json();
            const cards = get_cards(sync_data);
            const loans = get_loans(sync_data);

            const lines = html(loans, cards).join('\n');
            contentNode.innerHTML = lines;
        }

        async function cloneCode(e) {
            const chip_path = 'chip?client=dewey';
            const clone_path = 'chip/clone/code';

            e.preventDefault();

            const chip_url = proxy_base + encodeURI(overdrive_url_base + chip_path);
            const chip_response = await fetch(chip_url, { method: 'POST' });
            const chip_data = await chip_response.json();
            const bearer = chip_data.identity;

            const code = new FormData(e.target).get('code');

            const clone_url = encodeURI(proxy_base + overdrive_url_base + clone_path);
            const clone_response = await fetch(
                clone_url,
                {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${bearer}`,
                        'Content-Type': 'application/json',
                    },
                    body: `{"code":"${code}"}`,
                });
            if (clone_response.ok) {
                window.localStorage.setItem(bearerTokenKey, bearer);
                loadContent(bearer);
                return;
            }
        }

        function get_cards(data) {
            cards = Object();
            for (card of data.cards) {
                cards[card.cardId] = card;
            }
            return cards;
        }

        function get_loans(data) {
            return data.loans.map(parse_loan);
        }

        function parse_loan(loan_data) {
            loan_data.expireDate = new Date(loan_data.expireDate);
            return loan_data;
        }

        function html(loans, cards) {
            lines = []
            if (loans) {
                start_section(lines, 'Loans');
                start_table(lines, '&#x23f3; Expires', '&#x1f4da; Title', '&#x1f468; Borrower');
                for (loan of loans) {
                    add_row(lines, loan.expireDate.toLocaleString('en-CA'), loan.title, cards[loan.cardId].cardName);
                }
                end_table(lines);

                end_section(lines);
            }
            return lines;
        }

        function start_section(lines, text) {
            lines.push(`<div id='${slug(text)}'>`);
            lines.push(`<h2>${text}</h2>`);
        }

        function end_section(lines) {
            lines.push('</div>');
        }

        function start_table(lines, ...column_headers) {
            lines.push('<table>')
            lines.push('  <thead>')
            lines.push('    <tr>')
            for (h of column_headers) {
                lines.push(`      <th>${h}</th>`)
            }
            lines.push('  </thead>')
            lines.push('  <tbody>')
        }


        function add_row(lines, ...cell_values) {
            var text = '    <tr>';
            for (v of cell_values) {
                text += `<td>${v}</td>`;
            }
            text += '</tr>';
            lines.push(text);
        }

        function end_table(lines) {
            lines.push('</table>');
        }

        function slug(text) {
            return text.toLowerCase().replace(' ', '-')
        }

    </script>
</body>

</html>