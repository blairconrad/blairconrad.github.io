<html>

<head>
    <title>Libby</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <link rel="icon" type="image/x-icon" href="/images/libraryhippo-icon-64.ico" />
    <style>
        #waiting-holds td:first-child {
            text-align: right;

            /* otherwise it fetches up against the next column */
            padding-right: 2em;
        }
    </style>
</head>

<body>
    <div id="content" />
    <script async>
        const proxyBase = 'https://libby-proxy.blairconrad.workers.dev/proxy?proxyUrl='
        const overdriveUrlBase = 'https://sentry-read.svc.overdrive.com/'
        const bearerTokenKey = 'libby.bearer.token';
        window.onload = async (event) => {

            const locationUrl = new URL(window.location.href);

            if (locationUrl.searchParams.has('reset')) {
                window.localStorage.removeItem(bearerTokenKey);
            }

            var bearer = window.localStorage.getItem(bearerTokenKey);
            if (bearer) {
                loadContent(bearer);
            } else {
                const codeInput = document.createElement('input');
                codeInput.setAttribute('autocomplete', 'off');
                codeInput.setAttribute('autofocus', 'autofocus');
                codeInput.setAttribute('id', 'code');
                codeInput.setAttribute('maxlength', 8);
                codeInput.setAttribute('name', 'code');
                codeInput.setAttribute('pattern', '[0-9]{8}');
                codeInput.setAttribute('placeholder', '12345678');
                codeInput.setAttribute('required', 'required');
                codeInput.setAttribute('size', '8');
                codeInput.setAttribute('title', '8-digit one-time Libby code');
                codeInput.setAttribute('type', 'text');

                const codeSubmit = document.createElement('input');
                codeSubmit.setAttribute('type', 'submit');
                codeSubmit.setAttribute('value', 'Submit');

                const codeForm = document.createElement('form');
                codeForm.appendChild(codeInput);
                codeForm.appendChild(codeSubmit);
                codeForm.addEventListener('submit', cloneCode);

                const codeText = document.createElement('p');
                codeText.innerHTML = `
You don't appear to have registered your Libby Account. Enter an
8-digit code <a href="https://help.libbyapp.com/en-us/6070.htm">you can get from another logged-in
Libby account</a>.
`;

                const contentNode = document.getElementById('content');
                contentNode.replaceChildren(codeText, codeForm);
            }
        };

        async function loadContent(bearer) {
            const contentNode = document.getElementById('content');
            contentNode.innerHTML = 'loading&hellip;';

            const syncPath = 'chip/sync';
            const syncUrl = proxyBase + encodeURI(overdriveUrlBase + syncPath);
            const response = await fetch(syncUrl, { headers: { 'Authorization': 'Bearer ' + bearer } });
            const syncData = await response.json();
            const cards = getCards(syncData);
            const loans = getLoans(syncData);

            const lines = html(loans, cards).join('\n');
            contentNode.innerHTML = lines;
        }

        async function cloneCode(e) {
            const chipPath = 'chip?client=dewey';
            const clonePath = 'chip/clone/code';

            e.preventDefault();

            const chipUrl = proxyBase + encodeURI(overdriveUrlBase + chipPath);
            const chipResponse = await fetch(chipUrl, { method: 'POST' });
            const chipData = await chipResponse.json();
            const bearer = chipData.identity;

            const code = new FormData(e.target).get('code');

            const cloneUrl = encodeURI(proxyBase + overdriveUrlBase + clonePath);
            const cloneResponse = await fetch(
                cloneUrl,
                {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${bearer}`,
                        'Content-Type': 'application/json',
                    },
                    body: `{"code":"${code}"}`,
                });
            if (cloneResponse.ok) {
                window.localStorage.setItem(bearerTokenKey, bearer);
                loadContent(bearer);
                return;
            }
        }

        function getCards(data) {
            cards = Object();
            for (card of data.cards) {
                cards[card.cardId] = card;
            }
            return cards;
        }

        function getLoans(data) {
            return data.loans.map(parseLoan);
        }

        function parseLoan(loanData) {
            loanData.expireDate = new Date(loanData.expireDate);
            return loanData;
        }

        function html(loans, cards) {
            lines = []
            if (loans) {
                startSection(lines, 'Loans');
                startTable(lines, '&#x23f3; Expires', '&#x1f4da; Title', '&#x1f468; Borrower');
                for (loan of loans) {
                    addRow(lines, loan.expireDate.toLocaleString('en-CA'), loan.title, cards[loan.cardId].cardName);
                }
                endTable(lines);

                endSection(lines);
            }
            return lines;
        }

        function startSection(lines, text) {
            lines.push(`<div id='${slug(text)}'>`);
            lines.push(`<h2>${text}</h2>`);
        }

        function endSection(lines) {
            lines.push('</div>');
        }

        function startTable(lines, ...columnHeaders) {
            lines.push('<table>')
            lines.push('  <thead>')
            lines.push('    <tr>')
            for (h of columnHeaders) {
                lines.push(`      <th>${h}</th>`)
            }
            lines.push('  </thead>')
            lines.push('  <tbody>')
        }


        function addRow(lines, ...cellValues) {
            var text = '    <tr>';
            for (v of cellValues) {
                text += `<td>${v}</td>`;
            }
            text += '</tr>';
            lines.push(text);
        }

        function endTable(lines) {
            lines.push('</table>');
        }

        function slug(text) {
            return text.toLowerCase().replace(' ', '-')
        }

    </script>
</body>

</html>