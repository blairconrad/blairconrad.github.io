<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>FakeItEasy's argument formatter auto-discovery - boon and inconvenience - Blair Conrad</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blairconrad.com/2013/06/17/fakeiteasys-argument-formatter-auto-discovery-boon-and-inconvenience/">

        <meta name="author" content="Blair Conrad" />
        <meta name="description" content=".NET FakeItEasy Hi again. At the Day Job, we&#39;ve recently dropped Typemock Isolator and NMock2 as the mocking frameworks of choice in the products that I work on. We&#39;ve jumped on the FakeItEasy bandwagon. So far, we&#39;re enjoying the change. FakeItEasy is powerful enough and the concepts and syntax fit …" />

        <meta property="og:site_name" content="Blair Conrad" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="FakeItEasy&#39;s argument formatter auto-discovery - boon and inconvenience"/>
        <meta property="og:url" content="https://blairconrad.com/2013/06/17/fakeiteasys-argument-formatter-auto-discovery-boon-and-inconvenience/"/>
        <meta property="og:description" content=".NET FakeItEasy Hi again. At the Day Job, we&#39;ve recently dropped Typemock Isolator and NMock2 as the mocking frameworks of choice in the products that I work on. We&#39;ve jumped on the FakeItEasy bandwagon. So far, we&#39;re enjoying the change. FakeItEasy is powerful enough and the concepts and syntax fit …"/>
        <meta property="article:published_time" content="2013-06-17" />
            <meta property="article:section" content="Development" />
            <meta property="article:author" content="Blair Conrad" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blairconrad.com/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blairconrad.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blairconrad.com/theme/css/pygments/github.css" rel="stylesheet">
    <link href="https://blairconrad.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/style.css" type="text/css"/>
        <link href="https://blairconrad.com/theme/css/custom.css" rel="stylesheet">

        <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blair Conrad ATOM Feed"/>

        <link href="https://blairconrad.com/feeds/development.atom.xml" type="application/atom+xml" rel="alternate"
              title="Blair Conrad Development ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blairconrad.com/" class="navbar-brand">
Blair Conrad            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/Recipes">Recipes</a></li>
                        <li class="active">
                            <a href="https://blairconrad.com/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="https://blairconrad.com/category/miscellany.html">Miscellany</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blairconrad.com/2013/06/17/fakeiteasys-argument-formatter-auto-discovery-boon-and-inconvenience/"
                       rel="bookmark"
                       title="Permalink to FakeItEasy's argument formatter auto-discovery - boon and inconvenience">
                        FakeItEasy's argument formatter auto-discovery - boon and inconvenience
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span><i class="fa fa-calendar"></i><time datetime="2013-06-17T00:00:00-04:00">2013-06-17</time></span>
    <span><i class="fa fa-folder"></i><a href="https://blairconrad.com/category/development.html"></i>Development</a></span>


    

</footer><!-- /.post-info -->                    </div>
                </div>
                <ul>
<li>.NET</li>
<li>FakeItEasy</li>
</ul>
<hr>
<p>Hi again. At the Day Job, we've recently dropped <a href="http://www.typemock.com/isolator-product-page">Typemock Isolator</a> and <a href="http://sourceforge.net/apps/mediawiki/nmock2">NMock2</a> as the mocking frameworks of choice in the products that I work on. We've jumped on the <a href="http://fakeiteasy.github.io">FakeItEasy</a> bandwagon. So far, we're enjoying the change. FakeItEasy is powerful enough and the concepts and syntax fit the mind pretty well. Today I'm going to focus on one feature that I've really enjoyed but that has been an occasional thorn in the side.</p>
<p>This is a feature that <a href="http://ondevelopment.blogspot.ca/2010/09/extending-exception-messages-in.html">Patrik Hägne has blogged about before</a>, but that I think is still not well known. I found it accidentally, and have benefited from it. You can provide custom argument renderers to <strong>improve the messages</strong> you get when FakeItEasy detects an error due to missing or mismatched calls. Check out Mr. Hägne's post for the full details, but if I may be so bold as to rip off some of his examples, here's the gist (original meaning, not fancy github one).</p>
<!--more-->

<p>Define a class that extends <code>ArgumentValueFormatter&lt;Person&gt;</code> (where Person is a class in your project), override <code>GetStringValue</code> with something that renders a Person, and FakeItEasy errors that need to talk about a Person change from this
<pre>Assertion failed for the following call:
    'FakeItEasy.Examples.IPersonRepository.Save()'
  Expected to find it exactly never but found it #1 times among the calls:
    1.  'FakeItEasy.Examples.IPersonRepository.Save(
            personToSave: FakeItEasy.Examples.Person)'</pre></p>
<p>to
<pre>Assertion failed for the following call:
    'FakeItEasy.Examples.IPersonRepository.Save()'
  Expected to find it exactly never but found it #1 times among the calls:
    1.  'FakeItEasy.Examples.IPersonRepository.Save(
            personToSave: <b>Person named Patrik Hägne,
                          date of birth 1977-04-05 (12227,874689919 days old).)</b>'</pre></p>
<p>It's very easy to use, and quite helpful. However, lately I've had a few difficulties with some test projects and have tracked it back to an aspect of this feature. Specifically, for certain very large projects</p>
<ul>
<li>My test fixtures are <b>taking a long time to start up</b> - several extra seconds while waiting for the first test to run. Specifically, the delay was happening in my first <code>A.Fake</code> call.</li>
<li>During this delay, several "<b>LoaderLock was detected</b>" popups appear, which have no obvious ill effect, but are very annoying, and</li>
<li>Finally, after a recent upgrade of dependent libraries, when I run the tests using the <a href="http://www.jetbrains.com/resharper/features/unit_testing.html">Resharper test runner</a>, I see a "Microsoft Visual C++ Runtime Library <strong>Runtime Error!</strong>" in JetBrains.ReSharper.TestRunner.CLR4.exe. It claims that I'm trying to "use MSIL code from this assembly during native code initialzation". The tests continue to run, but the TestRunner process never exits, and needs to be killed before test can be run again.</li>
</ul>
<p>The reasons all these things are happening during the first FakeItEasy call is due to the way that FakeItEasy finds the custom <code>ArgumentValueFormatter</code> implementations. It <b>scans all available assemblies</b>, looking for any implementations. In this case, "all available assemblies" means every assembly in the <code>AppDomain</code> as well as all <code>*.dll</code> files in the current directory. This actually makes the feature a little more powerful than Mr. Hägne indicated&mdash;you can define your extensions in other assemblies than the test project's. In fact, this is how FakeItEasy finds its own built-in <code>ArgumentValueFormatter</code>s (one for <code>null</code>, one for <code>System.String</code>, and one for any <code>System.Object</code> that doesn't have its own extensions). FakeItEasy is in the AppDomain, so its extensions are located by the scan. One benefit of doing such a wide scan is that <b>it's possible to define the formatter extension classes in a shared library</b> that can be used across test projects.</p>
<p>It's the scanning that's causing my pain. First, some of the solutions at the Day Job are quite large, with dozens of assemblies in the test project's AppDomain and build directory. Even if everything went well, it would take seconds to load and scan all those assemblies.  Second, some of the DLLs in the directory aren't under our control. Some aren't managed. Some don't play well with others. It's these ones that are causing the other problems I mentioned above. <b>Loading these assemblies causes them to be accessed in ways that they were never planned to be</b>, which causes the LoaderLocks and Runtime Error.</p>
<p>What now? We're investigating the assemblies we're using to see if we can't access them in a better way, but that's probably going to be a slow operation, and one that may not bear fruit. In the meantime, I've forked FakeItEasy and am using the custom build in the one project that it was causing the most pain. <b>The custom version only loads extensions from the FakeItEasy assembly</b>. It's kind of a terrible hack, and means that we can't define custom extensions, but we hadn't for that project anyhow, so it's not yet causing pain. On the brighter side, there are no more errors or popups, and the tests start much more quickly.</p>
<p>Longer term, I've created <a href="https://github.com/FakeItEasy/FakeItEasy/issues/130">FakeItEasy issue 130 to make the extension location a little more flexible</a>. Once accepted and implemented, it will give the user control over how extension classes are located during FakeItEasy startup. (Then I can resume using the vanilla FakeItEasy at the Day Job.) If you're curious, pop on over and take a look.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Blair Conrad
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blairconrad.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blairconrad.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blairconrad.com/theme/js/respond.min.js"></script>




</body>
</html>