<!DOCTYPE html>
<html lang="en"     prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" >

<head>
    <title>Better formatter auto-discovery in FakeItEasy 1.13.0 - Blair Conrad</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blairconrad.com/2013/07/08/better-formatter-auto-discovery-in-fakeiteasy-1.13.0/">

        <meta name="author" content="Blair Conrad" />
        <meta name="keywords" content=".NET,FakeItEasy,Nancy" />
        <meta name="description" content="A few weeks ago, I wrote about the problems that FakeItEasy&#39;s assembly scanning was causing while it was looking for user-defined extensions. To recap, FakeItEasy was scanning all assemblies in the AppDomain and the working directory, looking for types that implemented IArgumentValueFormatter, IDummyDefinition, or IFakeConfigurator. This process was quite slow …" />

        <meta property="og:site_name" content="Blair Conrad" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Better formatter auto-discovery in FakeItEasy 1.13.0"/>
        <meta property="og:url" content="https://blairconrad.com/2013/07/08/better-formatter-auto-discovery-in-fakeiteasy-1.13.0/"/>
        <meta property="og:description" content="A few weeks ago, I wrote about the problems that FakeItEasy&#39;s assembly scanning was causing while it was looking for user-defined extensions. To recap, FakeItEasy was scanning all assemblies in the AppDomain and the working directory, looking for types that implemented IArgumentValueFormatter, IDummyDefinition, or IFakeConfigurator. This process was quite slow …"/>
        <meta property="article:published_time" content="2013-07-08" />
            <meta property="article:section" content="Development" />
            <meta property="article:tag" content=".NET" />
            <meta property="article:tag" content="FakeItEasy" />
            <meta property="article:tag" content="Nancy" />
            <meta property="article:author" content="Blair Conrad" />



    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/bootstrap.min.css" type="text/css" />

    <link href="https://blairconrad.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blairconrad.com/theme/css/pygments/github.css"
        rel="stylesheet">
    <link href="https://blairconrad.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/style.css" type="text/css" />
    <link href="https://blairconrad.com/theme/css/custom.css" rel="stylesheet">

    <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
        title="Blair Conrad ATOM Feed" />

    <link href="https://blairconrad.com/feeds/development.atom.xml" type="application/atom+xml" rel="alternate"
        title="Blair Conrad Development ATOM Feed" />
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top"
        role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="https://blairconrad.com/" class="navbar-brand">
Blair Conrad                </a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/Recipes">Recipes</a></li>
                        <li class="active" >
                            <a href="https://blairconrad.com/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="https://blairconrad.com/category/miscellany.html">Miscellany</a>
                        </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><span>
                            <form class="navbar-search" action="/search.html">
                                <input type="text" class="search-query" placeholder="Search" name="q"
                                    id="tipue_search_input" required>
                            </form>
                        </span>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
    </div> <!-- /.navbar -->

    <!-- Banner -->
    <!-- End Banner -->

    <!-- Content Container -->
    <div class="container">
        <div class="row">
            <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blairconrad.com/2013/07/08/better-formatter-auto-discovery-in-fakeiteasy-1.13.0/"
                       rel="bookmark"
                       title="Permalink to Better formatter auto-discovery in FakeItEasy 1.13.0">
                        Better formatter auto-discovery in FakeItEasy 1.13.0
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <!-- <span class="published"> -->
    <i class="fa fa-calendar"></i><time datetime="2013-07-08T00:00:00-04:00"> 2013-07-08</time>
    <!-- </span> -->



    <i class="fa fa-folder"></i>
    <a href="https://blairconrad.com/category/development.html"></i>Development</a>


<i class="fa fa-tags"></i>
<a href="https://blairconrad.com/tag/.net.html">.NET</a>
/
<a href="https://blairconrad.com/tag/fakeiteasy.html">FakeItEasy</a>
/
<a href="https://blairconrad.com/tag/nancy.html">Nancy</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>A few weeks ago, I wrote about <a href="https://blairconrad.com/2013/06/17/fakeiteasys-argument-formatter-auto-discovery-boon-and-inconvenience/">the problems that FakeItEasy's
assembly scanning <b>was causing</b></a> while it was looking for user-defined extensions. To recap,
FakeItEasy was scanning all assemblies in the AppDomain and the
working directory, looking for types that implemented
<code>IArgumentValueFormatter</code>, <code>IDummyDefinition</code>, or
<code>IFakeConfigurator</code>. This process was quite slow. Worse, it raised
LoaderLock exceptions when debugging, and Runtime errors anytime I ran
my tests using the ReSharper test runner.</p>
<p>At that time, I'd opened <a href="https://github.com/FakeItEasy/FakeItEasy/issues/130">issue130</a>, intended to allow configuration of the scanning
procedure. I'm happy to say that the issue has been closed "no
fix". Instead, I've contributed the fix for <a href="https://github.com/FakeItEasy/FakeItEasy/issues/133">Issue 133 &mdash; Improved performance of assembly scanning</a>. It doesn't
introduce any configuration options, but streamlines the scanning
process.</p>
<!--more-->

<p>The <strong>original behaviour</strong> was:</p>
<ol>
<li>find all the DLLs in the application directory</li>
<li>load all the found DLLs</li>
<li>find the distinct assemblies among those loaded from the directory and those already in the AppDomain</li>
<li>scan each assembly and add all the types to a list</li>
</ol>
<p>The <strong>new behaviour</strong>, heavily inspired by <a href="http://nancyfx.org/">Nancy</a>'s bootstrapper-finding code, is:</p>
<ol>
<li>find all the DLLs in the application directory</li>
<li>discard DLLs that are already part of the AppDomain - We don't even have to crack these files open again, since we already know everything about them. Note that this check <strong>examines the absolute paths to the DLL and the loaded assembly, and will be fooled by shadow copying</strong>. So, if your test runner makes shadow copies, this time won't be saved. I turned off shadow copying with no ill effects (and a tremendous speedup), but your mileage may vary.</li>
<li>load each remaining DLL <em>for reflection only</em> - This may be faster, and it may not, but it has another big advantage - it <strong>doesn't cause any of the code in the assembly to execute</strong>. (It was the execution of the assembly code that caused my LoaderLock and Runtime errors.)</li>
<li>
<p>for each assembly that references FakeItEasy, fully load it - If we don't do this, we can't scan for all the types in the assembly because </p>
<blockquote>
<p>When using the ReflectionOnly APIs, dependent assemblies must be pre-loaded or loaded on demand through the ReflectionOnlyAssemblyResolve event</p>
</blockquote>
<p>according to the <a href="https://github.com/FakeItEasy/FakeItEasy/issues/133#issuecomment-19728061">error I got when I tried it</a>. Note that excluding assemblies that don't reference FakeItEasy means <strong>we only examine assemblies that could possibly define formatting/dummy/configuration extensions</strong>, cutting down on the scanning time.</p>
</li>
<li>
<p>scan each of the following, remembering all contained types:</p>
<ul>
<li>the assemblies we just loaded from files,</li>
<li>the AppDomain assemblies that reference FakeItEasy, and</li>
<li>FakeItEasy - We need to include FakeItEasy explicitly because it
  defines its own formatter extensions, and since we're otherwise
  only looking at assemblies that reference FakeItEasy, we'd miss
  it.</li>
</ul>
</li>
</ol>
<p>This new scanning behaviour has been released in the <a
href="https://www.nuget.org/packages/FakeItEasy/1.13.0">FakeItEasy
1.13.0 build</a>, and has been a boon to me already. I'm enjoying the
faster test runs (0.534 seconds for my first test, versus 1.822 (or
more)) and the improved stability of the test runner. NuGet it now.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

            </div>
            <div class="col-sm-3" id="sidebar">
                <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="http://github.com/blairconrad"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
    <li class="list-group-item"><a href="http://twitter.com/hippopottoman"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
    <li class="list-group-item"><a href="https://www.goodreads.com/user/show/1066544-blair-conrad"><i class="fa fa-goodreads-square fa-lg"></i> Goodreads</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->                </aside>
            </div>
        </div>
    </div>
    <!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Blair Conrad
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <script src="https://blairconrad.com/theme/js/jquery.min.js"></script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://blairconrad.com/theme/js/bootstrap.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://blairconrad.com/theme/js/respond.min.js"></script>




</body>

</html>