<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="UTF-8" />
  <title>LibraryHippo 2020 - A Small Heroku Datastore | Blair Conrad</title>
  <link rel="stylesheet" href="https://blairconrad.com/static/m-dark.compiled.css" />
  <link rel="stylesheet" href="https://blairconrad.com/static/site.css" />
  <link rel="canonical" href="https://blairconrad.com/2020/04/23/libraryhippo-2020-a-small-heroku-datastore/" />
  <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blair Conrad" />
  <link href="https://blairconrad.com/feeds/development.atom.xml" type="application/atom+xml" rel="alternate" title="Blair Conrad | Development" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
  <meta property="og:site_name" content="Blair Conrad" />
  <meta property="og:title" content="LibraryHippo 2020 - A Small Heroku Datastore" />
  <meta name="twitter:title" content="LibraryHippo 2020 - A Small Heroku Datastore" />
  <meta property="og:url" content="https://blairconrad.com/2020/04/23/libraryhippo-2020-a-small-heroku-datastore/" />
  <meta property="og:description" content="Now the Heroku-hosted LibraryHippo can perform periodic tasks, send e-mails, and scrape the Waterloo Public Library&#39;s website. All it needs is a datastore to tie these concepts together into a decoupled &#34;push card status to patrons&#34; pipeline." />
  <meta name="twitter:description" content="Now the Heroku-hosted LibraryHippo can perform periodic tasks, send e-mails, and scrape the Waterloo Public Library&#39;s website. All it needs is a datastore to tie these concepts together into a decoupled &#34;push card status to patrons&#34; pipeline." />
  <meta name="twitter:card" content="summary" />
  <meta property="og:type" content="article" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="https://blairconrad.com/" id="m-navbar-brand" class="m-col-t-9 m-col-m-none m-left-m">Blair Conrad</a>
      <a id="m-navbar-show" href="#navigation" title="Show navigation" class="m-col-t-3 m-hide-m m-text-right"></a>
      <a id="m-navbar-hide" href="#" title="Hide navigation" class="m-col-t-3 m-hide-m m-text-right"></a>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-12 m-col-m-none">
            <li><a href="https://blairconrad.com/Recipes/">Recipes</a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main>
<div class="m-container">
  <div class="m-row">
    <article class="m-col-m-12 m-nopadb">
      
      <header>
          <h1><a href="https://blairconrad.com/2020/04/23/libraryhippo-2020-a-small-heroku-datastore/" rel="bookmark" title="Permalink to LibraryHippo 2020 - A Small Heroku Datastore">
                  LibraryHippo 2020 - A Small Heroku Datastore
              </a></h1>
              <div class="article-metadata">
                <span><i class="fas fa-calendar"></i><time
                    datetime="2020-04-23T00:00:00-04:00">2020-04-23</time></span>
                <span><i class="fas fa-folder"></i><a
                    href="https://blairconrad.com/category/development.html"></i>Development</a></span>
                <span><i class="fas fa-tags"></i>
                  <a href="https://blairconrad.com/tag/libraryhippo.html">LibraryHippo</a>
                  /
                  <a href="https://blairconrad.com/tag/flask.html">flask</a>
                  /
                  <a href="https://blairconrad.com/tag/heroku.html">heroku</a>
                  /
                  <a href="https://blairconrad.com/tag/database.html">database</a>
                </span>
              </div>
            <aside class="m-block m-default">
              <h3>Part 6 of the LibraryHippo 2020 series:</h3>
              <ol>
                <li>
                  <a href='https://blairconrad.com/2020/02/06/libraryhippo-2020-motivation-and-plan/'>Motivation and Plan</a>
                </li>
                <li>
                  <a href='https://blairconrad.com/2020/02/20/libraryhippo-2020-a-bare-bones-flask-app/'>A Bare-bones Flask App</a>
                </li>
                <li>
                  <a href='https://blairconrad.com/2020/03/05/libraryhippo-2020-sending-email-from-heroku/'>Sending Email from Heroku</a>
                </li>
                <li>
                  <a href='https://blairconrad.com/2020/03/19/libraryhippo-2020-running-scheduled-tasks-on-heroku/'>Running Scheduled Tasks on Heroku</a>
                </li>
                <li>
                  <a href='https://blairconrad.com/2020/04/09/libraryhippo-2020-scraping-library-websites/'>Scraping Library Websites</a>
                </li>
                <li>
                  A Small Heroku Datastore (this article)
                </li>
                <li>
                  <a href='https://blairconrad.com/2020/05/07/libraryhippo-2020-social-login/'>Social Login</a>
                </li>
                <li>
                  <a href='https://blairconrad.com/2020/05/21/libraryhippo-2020-recap-and-decision/'>Recap and decision</a>
                </li>
              </ol>
            </aside>
      </header>
      <div class="m-clearfix-l"></div>
<!-- content -->
<p>Now the Heroku-hosted LibraryHippo can perform periodic tasks, send e-mails, and
scrape the Waterloo Public Library's website. All it needs is a datastore to tie
these concepts together into a decoupled &quot;push card status to patrons&quot; pipeline.</p>
<section id="move-rendering-out-of-library">
<h2>Move rendering out of library</h2>
<p>Last time, the <code>WPL.check_card</code> method scraped a patron's holds and checkouts,
and rendered them as HTML for display to the user. It would be better to have
the library build a data structure, which can be stored for later use or
rendered by the web app.</p>
<figure class="m-code-figure">
<pre class="m-code"><span class="k">def</span> <span class="nf">check_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">summary_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">patron</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="n">holds_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">login_url</span><span class="p">(),</span>
        <span class="n">summary_page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;/holds$&quot;</span><span class="p">))[</span><span class="s2">&quot;href&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">checkouts_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">login_url</span><span class="p">(),</span>
        <span class="n">summary_page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;/items$&quot;</span><span class="p">))[</span><span class="s2">&quot;href&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">holds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_holds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">holds_url</span><span class="p">)</span>
    <span class="n">checkouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_checkouts</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">checkouts_url</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;holds&quot;</span><span class="p">:</span> <span class="n">holds</span><span class="p">,</span>
        <span class="s2">&quot;checkouts&quot;</span><span class="p">:</span> <span class="n">checkouts</span><span class="p">,</span>
    <span class="p">}</span></pre>
<figcaption>app/libraries/wpl.py</figcaption>
</figure>
<p>&quot;Data structure&quot; is maybe too fancy a term for &quot;dictionary with two values&quot;, but
it's a start.</p>
<figure class="m-code-figure">
<pre class="m-code"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/check&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
    <span class="n">card_check_result</span> <span class="o">=</span> <span class="n">WPL</span><span class="p">()</span><span class="o">.</span><span class="n">check_card</span><span class="p">(</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">PATRON_NAME</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">CARD_NUMBER</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">PIN</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;Holds&lt;/h1&gt;&quot;</span>
    <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">card_check_result</span><span class="p">[</span><span class="s2">&quot;holds&quot;</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;&lt;dl&gt;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hold</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;dt&gt;</span><span class="si">{k}</span><span class="s2">&lt;/dt&gt;&lt;dd&gt;</span><span class="si">{v}</span><span class="s2">&lt;/dd&gt;&quot;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/dl&gt;&lt;hr&gt;&quot;</span>

    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;&lt;h1&gt;Checkouts&lt;/h1&gt;&quot;</span>
    <span class="k">for</span> <span class="n">checkout</span> <span class="ow">in</span> <span class="n">card_check_result</span><span class="p">[</span><span class="s2">&quot;checkouts&quot;</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;&lt;dl&gt;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">checkout</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;dt&gt;</span><span class="si">{k}</span><span class="s2">&lt;/dt&gt;&lt;dd&gt;</span><span class="si">{v}</span><span class="s2">&lt;/dd&gt;&quot;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/dl&gt;&lt;hr&gt;&quot;</span>

    <span class="k">return</span> <span class="n">result</span></pre>
<figcaption>app/routes.py</figcaption>
</figure>
</section>
<section id="create-a-local-database">
<h2>Create a local database</h2>
<p>Flask doesn't come with a database of its own, like some web frameworks, but
there's an extension,
<a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/">Flask-SQLAlchemy</a>, that
helps it work with the <a href="https://www.sqlalchemy.org/">SQLAlchemy</a> Object
Relational Mapper. These will let LibraryHippo interact with databases both
locally and on Heroku. It's good practice to track changes to the database
schema using <a href="https://github.com/miguelgrinberg/flask-migrate">Flask-Migrate</a>,
so I'll install that as well.</p>
<pre class="m-console m-code"><span class="n">pip</span> <span class="n">install</span> <span class="n">Flask-SQLAlchemy</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">Flask-Migrate</span>
<span class="n">inv</span> <span class="n">freeze</span></pre>
<p>Flask needs some configuration settings to access the database.
<code>SQLALCHEMY_DATABASE_URI</code> describes how the application can contact the
database. In this case, there's a reasonable default, a local SQLite instance.
The <code>SQLALCHEMY_TRACK_MODIFICATIONS</code> setting will keep the database from
signalling the application whenever the database content changes.</p>
<figure class="m-code-figure">
<pre class="m-code"><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># …</span>
    <span class="c1"># Remove PATRON_NAME, CARD_NUMBER, and PIN, as they&#39;ll move to the database</span>

    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;DATABASE_URL&quot;</span>
    <span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;sqlite:///&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s2">&quot;app.db&quot;</span><span class="p">)</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span></pre>
<figcaption>config.py</figcaption>
</figure>
<p>Then the application needs to be taught about the database and migration facilities:</p>
<figure class="m-code-figure">
<pre class="m-code"><span class="c1"># …</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="c1"># …</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">Config</span><span class="p">)</span>

<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">routes</span><span class="p">,</span> <span class="n">models</span></pre>
<figcaption>app/__init__.py</figcaption>
</figure>
</section>
<section id="add-a-card">
<h2>Add a Card</h2>
<p>The application now has the ability to talk to the database, but there's no
schema defined. Let's add a model and insert a record.</p>
<figure class="m-code-figure">
<pre class="m-code"><span class="k">class</span> <span class="nc">Card</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">patron_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
    <span class="n">pin</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">last_state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Patron </span><span class="si">{self.patron_name}</span><span class="s2">&gt;&quot;</span></pre>
<figcaption>app/__init__.py</figcaption>
</figure>
<p>Every model gets an <code>id</code>, for convenience, and the next 3 fields will be
familiar from the previous article—they identify the card and control access to
the library card state. The last field, <code>last_state</code>, will be used to record
the last-checked card state. It'll hold a JSON-formatted version of the
dictionary that appears above.</p>
<section id="initialize-the-database">
<h3>Initialize the database</h3>
<p>Now initialize a schemaless database, add the first migration script for the
<code>Card</code> model, and actually upgrade the database schema:</p>
<figure class="m-console-figure">
<pre class="m-console m-code"><span class="n">flask</span> <span class="n">db</span> <span class="n">init</span>
<span class="n">flask</span> <span class="n">db</span> <span class="n">migrate</span> <span class="n">-m</span> <span class="s2">&quot;Add Card model&quot;</span>
<span class="n">flask</span> <span class="n">db</span> <span class="n">upgrade</span></pre>
<pre class="m-nopad m-code">Creating directory D:\Sandbox\LibraryHippo\migrations ...  done
Creating directory D:\Sandbox\LibraryHippo\migrations\versions ...  done
Generating D:\Sandbox\LibraryHippo\migrations\alembic.ini ...  done
Generating D:\Sandbox\LibraryHippo\migrations\env.py ...  done
Generating D:\Sandbox\LibraryHippo\migrations\README ...  done
Generating D:\Sandbox\LibraryHippo\migrations\script.py.mako ...  done
Please edit configuration/connection/logging settings in &#39;D:\\Sandbox\\LibraryHippo\\migrations\\alembic.ini&#39; before proceeding.

Generating D:\Sandbox\LibraryHippo\migrations\versions\b2fc8df2f32f_add_card_model.py ...  done</pre>
</figure>
</section>
<section id="insert-a-card-into-the-database">
<h3>Insert a card into the database</h3>
<p>Normally cards would be added to the database by the users, via a fancy form. For now, the <code>flask shell</code> will do.</p>
<pre class="m-console m-code"><span class="err">❯</span> <span class="n">flask</span> <span class="n">shell</span>
<span class="n">Python</span> <span class="mf">3.8</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">tags</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="mf">8.1</span><span class="p">:</span><span class="mi">1</span><span class="n">b293b6</span><span class="p">,</span> <span class="n">Dec</span> <span class="mi">18</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">22</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span> <span class="p">[</span><span class="n">MSC</span> <span class="n">v</span><span class="o">.</span><span class="mi">1916</span> <span class="mi">32</span> <span class="n">bit</span> <span class="p">(</span><span class="n">Intel</span><span class="p">)]</span> <span class="n">on</span> <span class="n">win32</span>
<span class="n">App</span><span class="p">:</span> <span class="n">app</span> <span class="p">[</span><span class="n">production</span><span class="p">]</span>
<span class="n">Instance</span><span class="p">:</span> <span class="n">D</span><span class="p">:</span>\<span class="n">Sandbox</span>\<span class="n">LibraryHippo</span>\<span class="n">instance</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Card</span><span class="p">,</span> <span class="n">db</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="n">patron_name</span><span class="o">=</span><span class="s2">&quot;Blair Conrad&quot;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="s2">&quot;123456789&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="s2">&quot;9876&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Card</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Patron</span> <span class="n">Blair</span> <span class="n">Conrad</span><span class="o">&gt;</span><span class="p">]</span></pre>
</section>
</section>
<section id="load-the-card-from-the-database-and-store-the-check-results">
<h2>Load the card from the database and store the check results</h2>
<p>The <code>Config</code> class no longer has the hard-coded patron name, card number, and
PIN values added last time, so the <code>check</code> route must load them from the
database and save the result back onto the card:</p>
<figure class="m-code-figure">
<pre class="m-code"><span class="c1"># …</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Card</span>

<span class="c1"># …</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/check&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
    <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># a hack - we know there&#39;s only 1 card for now</span>
    <span class="n">card_check_result</span> <span class="o">=</span> <span class="n">WPL</span><span class="p">()</span><span class="o">.</span><span class="n">check_card</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
    <span class="n">card</span><span class="o">.</span><span class="n">last_state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">card_check_result</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="c1"># rendering code…</span></pre>
<figcaption>app/routes.py</figcaption>
</figure>
<p>The stored result can be seen by querying the database via <code>flask shell</code>:</p>
<figure class="m-console-figure">
<pre class="m-console m-code"><span class="err">❯</span> <span class="n">flask</span> <span class="n">shell</span>
<span class="n">Python</span> <span class="mf">3.8</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">tags</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="mf">8.1</span><span class="p">:</span><span class="mi">1</span><span class="n">b293b6</span><span class="p">,</span> <span class="n">Dec</span> <span class="mi">18</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">22</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span> <span class="p">[</span><span class="n">MSC</span> <span class="n">v</span><span class="o">.</span><span class="mi">1916</span> <span class="mi">32</span> <span class="n">bit</span> <span class="p">(</span><span class="n">Intel</span><span class="p">)]</span> <span class="n">on</span> <span class="n">win32</span>
<span class="n">App</span><span class="p">:</span> <span class="n">app</span> <span class="p">[</span><span class="n">production</span><span class="p">]</span>
<span class="n">Instance</span><span class="p">:</span> <span class="n">D</span><span class="p">:</span>\<span class="n">Sandbox</span>\<span class="n">LibraryHippo</span>\<span class="n">instance</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Card</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">card</span><span class="o">.</span><span class="n">last_state</span></pre>
<pre class="m-nopad m-code"><span class="s1">&#39;{&quot;holds&quot;: [{&quot;Title&quot;: &quot;</span><span class="se">\\</span><span class="s1">nBlood heir / Am</span><span class="se">\\</span><span class="s1">u00e9lie Wen Zhao</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">n&quot;, &quot;Status&quot;: &quot; 2 of 2 holds &quot;, &quot;Pickup&quot;: &quot;WPL McCormick Branch&quot;, &quot;Cancel&quot;: &quot;09-17-20&quot;, &quot;Freeze&quot;: true}, {&quot;Title&quot;: &quot;</span><span class="se">\\</span><span class="s1">nEducated : a memoir / Tara Westover</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">n&quot;, &quot;Status&quot;: &quot; 1 of 2 holds &quot;, &quot;Pickup&quot;: &quot;WPL McCormick Branch&quot;, &quot;Cancel&quot;: &quot;09-28-20&quot;, &quot;Freeze&quot;: true}, {&quot;Title&quot;: &quot;</span><span class="se">\\</span><span class="s1">nCoders : the making of a new tribe and the remaking of the world / Clive Thompson</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">n&quot;, &quot;Status&quot;: &quot; 1 of 1 holds &quot;, &quot;Pickup&quot;: &quot;WPL McCormick Branch&quot;, &quot;Cancel&quot;: &quot;10-16-20&quot;, &quot;Freeze&quot;: true}, {&quot;Title&quot;: &quot;</span><span class="se">\\</span><span class="s1">nBecoming Superman : my journey from poverty to Hollywood : with stops along the way at murder, mayhem, movie stars, cults, slums, sociopaths, and war crimes / J. Michael Straczynski ; introduction by Neil Gaiman</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">n&quot;, &quot;Status&quot;: &quot; 1 of 1 holds &quot;, &quot;Pickup&quot;: &quot;WPL McCormick Branch&quot;, &quot;Cancel&quot;: &quot;11-02-20&quot;, &quot;Freeze&quot;: true}, {&quot;Title&quot;: &quot;</span><span class="se">\\</span><span class="s1">nBatman : Creature of the Night / illustrated by John Paul Leon.</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">n&quot;, &quot;Status&quot;: &quot; 4 of 6 holds &quot;, &quot;Pickup&quot;: &quot;WPL McCormick Branch&quot;, &quot;Cancel&quot;: &quot;11-06-2</span></pre>
</figure>
</section>
<section id="use-the-stored-card-check-result-to-send-e-mail">
<h2>Use the stored card check result to send e-mail</h2>
<p>Now that the database contains the result of the last card status check, it's
relatively straightforward to include that text in the notification e-mails. All
that's required is to load the card record, deserialize the saved state using
<code>json.loads</code>, and build the HTML:</p>
<figure class="m-code-figure">
<pre class="m-code"><span class="c1"># …</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">mail</span><span class="p">,</span> <span class="n">models</span>

<span class="c1"># …</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;notify-all&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">notify_all</span><span class="p">():</span>
        <span class="n">card</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Card</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># a hack - we know there&#39;s only 1 card for now</span>
        <span class="n">last_card_state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">last_state</span><span class="p">)</span>

        <span class="n">html_body</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;Holds&lt;/h1&gt;&quot;</span>
        <span class="k">for</span> <span class="n">hold</span> <span class="ow">in</span> <span class="n">last_card_state</span><span class="p">[</span><span class="s2">&quot;holds&quot;</span><span class="p">]:</span>
            <span class="n">html_body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;dl&gt;&quot;</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hold</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">html_body</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;dt&gt;</span><span class="si">{k}</span><span class="s2">&lt;/dt&gt;&lt;dd&gt;</span><span class="si">{v}</span><span class="s2">&lt;/dd&gt;&quot;</span>
            <span class="n">html_body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/dl&gt;&lt;hr&gt;&quot;</span>

        <span class="n">html_body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;h1&gt;Checkouts&lt;/h1&gt;&quot;</span>
        <span class="k">for</span> <span class="n">checkout</span> <span class="ow">in</span> <span class="n">last_card_state</span><span class="p">[</span><span class="s2">&quot;checkouts&quot;</span><span class="p">]:</span>
            <span class="n">html_body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;dl&gt;&quot;</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">checkout</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">html_body</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;dt&gt;</span><span class="si">{k}</span><span class="s2">&lt;/dt&gt;&lt;dd&gt;</span><span class="si">{v}</span><span class="s2">&lt;/dd&gt;&quot;</span>
            <span class="n">html_body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/dl&gt;&lt;hr&gt;&quot;</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
            <span class="s2">&quot;LibraryHippo starting notifications&quot;</span><span class="p">,</span> <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;blair@blairconrad.com&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;starting notifications at </span><span class="si">{now}</span><span class="s2">&quot;</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">html_body</span>

        <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># …</span></pre>
<figcaption>app/cli.py</figcaption>
</figure>
</section>
<section id="deploy-to-heroku">
<h2>Deploy to Heroku</h2>
<p>There's nothing left to do but try this out on Heroku. It shouldn't be too much work.</p>
<section id="add-and-configure-a-database-plugin">
<h3>Add and configure a database plugin</h3>
<p>Heroku has a free hobby-tier PostgreSQL addon that you can add on right from the command line:</p>
<figure class="m-console-figure">
<pre class="m-console m-code"><span class="n">heroku</span> <span class="n">addons</span><span class="err">:</span><span class="n">add</span> <span class="n">heroku-postgresql</span><span class="err">:</span><span class="n">hobby-dev</span></pre>
<pre class="m-nopad m-code">Creating heroku-postgresql:hobby-dev on ⬢ libraryhippo... free
Database has been created and is available
! This database is empty. If upgrading, you can transfer
! data from another database with pg:copy
Created ·················· as DATABASE_URL
Use heroku addons:docs heroku-postgresql to view documentation</pre>
</figure>
<p>The addon sets the <code>DATABASE_URL</code> environment variable, which
is the one that the <code>Config.SQLALCHEMY_TRACK_MODIFICATIONS</code> attribute is
populated from.</p>
<p>SQLAlchemy needs a bonus <code>psycopg2</code> package to connect to the database, and
there's no harm in having it installed when I'm testing locally, so I'll just
add it to <code>requirements.txt</code>:</p>
<pre class="m-console m-code"><span class="n">pip</span> <span class="n">install</span> <span class="n">psycopg2</span>
<span class="n">inv</span> <span class="n">freeze</span></pre>
<p>Finally, the application startup should perform the database migration, to react
to any new model changes. This requires an extra command before starting gunicorn:</p>
<pre class="m-code">web: flask db upgrade; gunicorn libraryhippo:app</pre>
<p>And the only thing left to do is deploy.</p>
</section>
<section id="store-a-library-card">
<h3>Store a library card</h3>
<p>I'll store the library card to the PostgreSQL database just as with the local
sqlite instance. The only difference is that instead of running <code>flask shell</code>
directly, I use Heroku's facility to run a one-off command via <code>heroku run</code>:</p>
<pre class="m-console m-code"><span class="err">❯</span> <span class="n">heroku</span> <span class="n">run</span> <span class="n">flask</span> <span class="n">shell</span>
<span class="n">Running</span> <span class="n">flask</span> <span class="n">shell</span> <span class="n">on</span> <span class="err">⬢</span> <span class="n">libraryhippo</span><span class="o">...</span> <span class="n">up</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="mi">4950</span> <span class="p">(</span><span class="n">Free</span><span class="p">)</span>
<span class="n">Python</span> <span class="mf">3.8</span><span class="o">.</span><span class="mi">1</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Dec</span> <span class="mi">23</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">04</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">22</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">7.4</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="n">App</span><span class="p">:</span> <span class="n">app</span> <span class="p">[</span><span class="n">production</span><span class="p">]</span>
<span class="n">Instance</span><span class="p">:</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">instance</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Card</span><span class="p">,</span> <span class="n">db</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="n">patron_name</span><span class="o">=</span><span class="s2">&quot;Blair Conrad&quot;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="s2">&quot;123456789&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="s2">&quot;9876&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Card</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Patron</span> <span class="n">Blair</span> <span class="n">Conrad</span><span class="o">&gt;</span><span class="p">]</span></pre>
<p>With that done, there was no need to keep the old environment variables that encoded my library credentials, so I removed them:</p>
<pre class="m-console m-code"><span class="n">heroku</span> <span class="n">config</span><span class="err">:</span><span class="n">unset</span> <span class="n">PATRON_NAME</span> <span class="n">CARD_NUMBER</span> <span class="n">PIN</span></pre>
</section>
<section id="wait-for-the-e-mail">
<h3>Wait for the e-mail</h3>
<p>And that's it. I did visit <code>/check</code> on the website to ensure there was a
cached card status, and there was nothing else to do but wait until 18:30 local
time to see everything work together. Sure enough, the task woke up, read the
stored data, and used it in the e-mail:</p>
<figure class="m-figure">
<img alt="screenshot of notification e-mail sent from Heroku using stored card status" src="https://blairconrad.com/2020/04/23/libraryhippo-2020-a-small-heroku-datastore/heroku-notification-using-stored-status.png" />
<figcaption>Notification e-mail sent from Heroku using stored card status</figcaption>
</figure>
</section>
</section>
<section id="progress">
<h2>Progress</h2>
<p>Five of nine requirements have been met!</p>
<table class="m-table">
<tbody>
<tr><td><span class="m-label m-success">done</span></td>
<td>web app hosting</td>
<td></td>
</tr>
<tr><td><span class="m-label m-success">done</span></td>
<td>scheduled jobs (run in UTC)</td>
<td></td>
</tr>
<tr><td><span class="m-label m-success">done</span></td>
<td>scraping library websites on users' behalf</td>
<td></td>
</tr>
<tr><td><span class="m-label m-success">done</span></td>
<td>small persistent datastore</td>
<td></td>
</tr>
<tr><td><span class="m-label m-primary">next</span></td>
<td>social authentication</td>
<td></td>
</tr>
<tr><td><span class="m-label m-success">done</span></td>
<td>sending e-mail</td>
<td></td>
</tr>
<tr><td></td>
<td>nearly free</td>
<td></td>
</tr>
<tr><td></td>
<td>job queues</td>
<td></td>
</tr>
<tr><td></td>
<td>custom domain name</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<!-- /content -->
      <footer>
        <p class="m-transition">~ <i class="fas fa-hippo"></i> ~</p>


        <script src="https://utteranc.es/client.js"
            repo="blairconrad/blairconrad.github.io"
            issue-term="pathname"
            theme="photon-dark"
            crossorigin="anonymous"
            async>
        </script>
      </footer>
    </article">
  </div>
</div>
</main>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>Blair Conrad. Powered by <a href="https://getpelican.com">Pelican</a> and <a href="https://mcss.mosra.cz">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>