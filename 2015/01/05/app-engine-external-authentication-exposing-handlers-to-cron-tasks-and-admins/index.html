<!DOCTYPE html>
<html lang="en"     prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" >

<head>
    <title>App Engine + External Authentication: Exposing Handlers to Cron, Tasks, and Admins - Blair Conrad</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blairconrad.com/2015/01/05/app-engine-external-authentication-exposing-handlers-to-cron-tasks-and-admins/">

        <meta name="author" content="Blair Conrad" />
        <meta name="keywords" content="AppEngine" />
        <meta name="description" content="Since Google is deprecating OpenID 2.0 support, I decided to update LibraryHippo to authenticate via OAuth 2.0, which is a story in itself, but I&#39;m here to talk about what happened next. LibraryHippo has a set of handlers that are accessed primarily via the Cron and Task Queue …" />

        <meta property="og:site_name" content="Blair Conrad" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="App Engine + External Authentication: Exposing Handlers to Cron, Tasks, and Admins"/>
        <meta property="og:url" content="https://blairconrad.com/2015/01/05/app-engine-external-authentication-exposing-handlers-to-cron-tasks-and-admins/"/>
        <meta property="og:description" content="Since Google is deprecating OpenID 2.0 support, I decided to update LibraryHippo to authenticate via OAuth 2.0, which is a story in itself, but I&#39;m here to talk about what happened next. LibraryHippo has a set of handlers that are accessed primarily via the Cron and Task Queue …"/>
        <meta property="article:published_time" content="2015-01-05" />
            <meta property="article:section" content="Development" />
            <meta property="article:tag" content="AppEngine" />
            <meta property="article:author" content="Blair Conrad" />



    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/bootstrap.min.css" type="text/css" />

    <link href="https://blairconrad.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blairconrad.com/theme/css/pygments/github.css"
        rel="stylesheet">
    <link href="https://blairconrad.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blairconrad.com/theme/css/style.css" type="text/css" />
    <link href="https://blairconrad.com/theme/css/custom.css" rel="stylesheet">

    <link href="https://blairconrad.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
        title="Blair Conrad ATOM Feed" />

    <link href="https://blairconrad.com/feeds/development.atom.xml" type="application/atom+xml" rel="alternate"
        title="Blair Conrad Development ATOM Feed" />
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top"
        role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="https://blairconrad.com/" class="navbar-brand">
Blair Conrad                </a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/Recipes">Recipes</a></li>
                        <li class="active" >
                            <a href="https://blairconrad.com/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="https://blairconrad.com/category/miscellany.html">Miscellany</a>
                        </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><span>
                            <form class="navbar-search" action="/search.html">
                                <input type="text" class="search-query" placeholder="Search" name="q"
                                    id="tipue_search_input" required>
                            </form>
                        </span>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
    </div> <!-- /.navbar -->

    <!-- Banner -->
    <!-- End Banner -->

    <!-- Content Container -->
    <div class="container">
        <div class="row">
            <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blairconrad.com/2015/01/05/app-engine-external-authentication-exposing-handlers-to-cron-tasks-and-admins/"
                       rel="bookmark"
                       title="Permalink to App Engine + External Authentication: Exposing Handlers to Cron, Tasks, and Admins">
                        App Engine + External Authentication: Exposing Handlers to Cron, Tasks, and Admins
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <!-- <span class="published"> -->
    <i class="fa fa-calendar"></i><time datetime="2015-01-05T00:00:00-05:00"> 2015-01-05</time>
    <!-- </span> -->



    <i class="fa fa-folder"></i>
    <a href="https://blairconrad.com/category/development.html"></i>Development</a>


<i class="fa fa-tags"></i>
<a href="https://blairconrad.com/tag/appengine.html">AppEngine</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Since Google is <a href="https://developers.google.com/accounts/docs/OpenID2">deprecating OpenID 2.0 support</a>, I
decided to update <a href="/tags/#LibraryHippo-ref">LibraryHippo</a> to authenticate via
<a href="http://oauth.net/">OAuth 2.0</a>, which is a story in itself, but I'm here to talk
about what happened next.</p>
<p>LibraryHippo has a set of handlers that are accessed primarily via the
<a href="https://cloud.google.com/appengine/docs/python/config/cron">Cron</a> and <a href="https://cloud.google.com/appengine/docs/python/taskqueue/">Task Queue</a> mechanisms, but every once in a
while need to be triggered ad hoc by a human administrator. Up 'til
now, these request handlers were protected from the rabble by
<a href="https://cloud.google.com/appengine/docs/python/config/appconfig#Python_app_yaml_Requiring_login_or_administrator_status">requiring administrator status via the application's app.yaml</a>. Unfortunately,
externally-authenticated users have no special standing within App
Engine, so this restriction had to be relaxed.</p>
<p>My first thought was to remove the restriction from app.yaml and check
for access in the handler like so:</p>
<pre><code class="python">if (users.is_current_user_admin() or
    self.is_external_user_admin()) # application code that understands the logged-in users
    # do stuff
else:
    self.abort(403)</code></pre>

<p>Unfortunately, this fails miserably. When the handler is executed by a
task or cron job, <code>users.is_current_user_admin</code> returns <code>False</code>.</p>
<p>This behaviour seems not to be widely reported; I couldn't find it
mentioned in the <a href="https://code.google.com/p/googleappengine/issues/list?can=1">App Engine issues list</a>, but a web search
eventually turned up
<a href="http://www.learningtechnicalstuff.com/2010/01/app-engine-google-fails.html">App Engine: Google fails users.is_current_user_admin() test</a>
by Ben Davies, an article written nearly 5 years ago.</p>
<p>In this article, Mr. Davies suggests that the best alternative to
<code>users.is_current_user_admin</code> is to "check the easily spoofed request
user-agent". I was skittish of this approach, especially since Google
is now recommending checking <code>X-AppEngine-Cron</code> when
<a href="https://cloud.google.com/appengine/docs/python/config/cron#Python_app_yaml_Securing_URLs_for_cron">securing URLS for cron</a>. The App Engine documentation
explains how X-AppEngine-Cron is protected against spoofing, but I'm
still uneasy.</p>
<p>I ended up taking a different approach. I added two routes for the
affected handlers. One route is in the old "admin" subdirectory
(subpath?) and the other in a new one for system commands,
"system". The latter is secured in the app.yaml, just as before. Thus
I have:</p>
<pre><code class="yaml"># in app.yaml
- url: /system/.*
  script: libraryhippo.application
  login: admin</code></pre>

<pre><code class="python"># in the application's Python source
handlers = [
    # other handlers
    ('/admin/notify/(.*)$', Notify),
    ('/system/notify/(.*)$', Notify),
    ]

# and later, in the Notify handler
    request_path = urlparse.urlsplit(self.request.url).path
    if (self.is_external_user_admin() or
        not request_path.startswith('/admin/'))
        # do stuff
    else:
        self.abort(403)</code></pre>

<p>Thus the handler is executed if the user has admin rights or the URL
isn't locked down by virtue of being below '/admin/'. The '/system/'
URLs are all assumed to be protected by the app.yaml setting.</p>
<p>Perhaps this is technically no better than checking a header in the
request, but it works for me, at least until I see what happens with
<a href="https://code.google.com/p/googleappengine/issues/detail?id=11576">Issue 11576: have users.is_current_user_admin return true for tasks and cron jobs</a>.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

            </div>
            <div class="col-sm-3" id="sidebar">
                <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="http://github.com/blairconrad"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
    <li class="list-group-item"><a href="http://twitter.com/hippopottoman"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
    <li class="list-group-item"><a href="https://www.goodreads.com/user/show/1066544-blair-conrad"><i class="fa fa-goodreads-square fa-lg"></i> Goodreads</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->                </aside>
            </div>
        </div>
    </div>
    <!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Blair Conrad
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <script src="https://blairconrad.com/theme/js/jquery.min.js"></script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://blairconrad.com/theme/js/bootstrap.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://blairconrad.com/theme/js/respond.min.js"></script>




</body>

</html>